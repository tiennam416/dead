local Players = game:GetService("Players")
local player = Players.LocalPlayer
player.CameraMode = Enum.CameraMode.Classic
local runService = game:GetService("RunService")
local StarterGui = game:GetService("StarterGui")
local camera = workspace.CurrentCamera
local UserInputService = game:GetService("UserInputService")
local Lighting = game:GetService("Lighting")

-- Thông báo khởi đầu
StarterGui:SetCore("SendNotification", {
    Title = "Utility Menu",
    Text = "Created by GioBolqvi",
    Duration = 3
})

-- Tạo ScreenGui
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "UtilityMenu"
screenGui.Parent = game:GetService("CoreGui")
screenGui.ResetOnSpawn = false

-- Tạo Frame chính cho menu
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 200, 0, 250)
mainFrame.Position = UDim2.new(0.5, -100, 0.5, -125)
mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
mainFrame.BorderSizePixel = 0
mainFrame.Parent = screenGui
mainFrame.Visible = false

-- Thêm UICorner cho Frame
local frameCorner = Instance.new("UICorner")
frameCorner.CornerRadius = UDim.new(0, 10)
frameCorner.Parent = mainFrame

-- Thêm tiêu đề
local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, 0, 0, 40)
title.Position = UDim2.new(0, 0, 0, 0)
title.BackgroundTransparency = 1
title.Text = "Utility Menu"
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.Font = Enum.Font.GothamBold
title.TextSize = 20
title.Parent = mainFrame

-- Hàm tạo nút
local function createButton(name, position, text)
    local button = Instance.new("TextButton")
    button.Name = name
    button.Size = UDim2.new(0, 160, 0, 40)
    button.Position = position
    button.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    button.TextColor3 = Color3.fromRGB(255, 255, 255)
    button.Text = text
    button.Font = Enum.Font.Gotham
    button.TextSize = 16
    button.Parent = mainFrame
    
    local buttonCorner = Instance.new("UICorner")
    buttonCorner.CornerRadius = UDim.new(0, 8)
    buttonCorner.Parent = button
    
    return button
end

-- Tạo các nút
local npcButton = createButton("NPCLock", UDim2.new(0.5, -80, 0, 70), "NPC Lock: OFF")
local noclipButton = createButton("NoClip", UDim2.new(0.5, -80, 0, 120), "NoClip: OFF")
local nightVisionButton = createButton("NightVision", UDim2.new(0.5, -80, 0, 170), "Nhìn Trong Đêm: OFF")

-- Hàm làm đối tượng có thể kéo thả
local function makeDraggable(frame)
    local dragging = false
    local dragInput, dragStart, startPos

    local function update(input)
        local delta = input.Position - dragStart
        frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end

    frame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = frame.Position

            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)

    frame.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if dragging and input == dragInput then
            update(input)
        end
    end)
end

makeDraggable(mainFrame)

-- Logic NPC Lock
local npcLock = false
local toggleLoop

local function getClosestNPC()
    local closestNPC = nil
    local closestDistance = math.huge

    for _, object in ipairs(workspace:GetDescendants()) do
        if object:IsA("Model") then
            local humanoid = object:FindFirstChild("Humanoid")
            local hrp = object:FindFirstChild("HumanoidRootPart") or object.PrimaryPart
            if humanoid and hrp and humanoid.Health > 0 and object.Name ~= "Horse" then
                local isPlayer = Players:GetPlayerFromCharacter(object) ~= nil
                if not isPlayer then
                    local distance = (hrp.Position - player.Character.HumanoidRootPart.Position).Magnitude
                    if distance < closestDistance then
                        closestDistance = distance
                        closestNPC = object
                    end
                end
            end
        end
    end
    return closestNPC
end

local function toggleNPCLock(state)
    npcLock = state
    npcButton.Text = npcLock and "NPC Lock: ON" or "NPC Lock: OFF"
    
    if npcLock then
        if not toggleLoop then
            toggleLoop = runService.RenderStepped:Connect(function()
                if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then return end
                local npc = getClosestNPC()
                if npc and npc:FindFirstChild("Humanoid") then
                    local npcHumanoid = npc:FindFirstChild("Humanoid")
                    if npcHumanoid.Health > 0 then
                        camera.CameraSubject = npcHumanoid
                    else
                        if player.Character and player.Character:FindFirstChild("Humanoid") then
                            camera.CameraSubject = player.Character:FindFirstChild("Humanoid")
                        end
                    end
                else
                    if player.Character and player.Character:FindFirstChild("Humanoid") then
                        camera.CameraSubject = player.Character:FindFirstChild("Humanoid")
                    end
                end
            end)
        end
    else
        if toggleLoop then
            toggleLoop:Disconnect()
            toggleLoop = nil
        end
        if player.Character and player.Character:FindFirstChild("Humanoid") then
            camera.CameraSubject = player.Character:FindFirstChild("Humanoid")
        end
    end
end

npcButton.MouseButton1Click:Connect(function()
    toggleNPCLock(not npcLock)
end)

-- Logic NoClip
local noclip = false
local noclipConnection

local function toggleNoClip(state)
    noclip = state
    if noclipConnection then
        noclipConnection:Disconnect()
        noclipConnection = nil
    end
    if noclip then
        noclipConnection = runService.Stepped:Connect(function()
            if player.Character then
                for _, part in ipairs(player.Character:GetChildren()) do
                    if part:IsA("BasePart") then
                        part.CanCollide = false
                    end
                end
            end
        end)
    end
end

noclipButton.MouseButton1Click:Connect(function()
    toggleNoClip(not noclip)
    noclipButton.Text = noclip and "NoClip: ON" or "NoClip: OFF"
end)

-- Logic Nhìn Trong Đêm
local nightVisionEnabled = false
local defaultLighting = {} -- Lưu trữ trạng thái ánh sáng mặc định
local nightVisionLoop -- Biến để lưu kết nối vòng lặp

-- Lưu trạng thái ánh sáng ban đầu khi script khởi chạy
local function saveDefaultLighting()
    defaultLighting.Ambient = Lighting.Ambient or Color3.fromRGB(0, 0, 0)
    defaultLighting.Brightness = Lighting.Brightness or 1
    defaultLighting.GlobalShadows = Lighting.GlobalShadows or true
    defaultLighting.ClockTime = Lighting.ClockTime or 14
    defaultLighting.TimeOfDay = Lighting.TimeOfDay or "14:00:00"
    defaultLighting.FogEnd = Lighting.FogEnd or 100
    defaultLighting.FogColor = Lighting.FogColor or Color3.fromRGB(192, 192, 192)
end

-- Áp dụng và đóng băng Night Vision
local function applyNightVision()
    nightVisionEnabled = true
    nightVisionButton.Text = "Nhìn Trong Đêm: ON"
    
    -- Đóng băng giá trị bằng vòng lặp
    if not nightVisionLoop then
        nightVisionLoop = runService.RenderStepped:Connect(function()
            if nightVisionEnabled then
                Lighting.Ambient = Color3.fromRGB(255, 255, 255) -- Ánh sáng trắng tối đa
                Lighting.Brightness = 3 -- Độ sáng cao
                Lighting.GlobalShadows = false -- Tắt bóng
                Lighting.ClockTime = 12 -- Giữ ở giữa trưa
                Lighting.TimeOfDay = "12:00:00"
                Lighting.FogEnd = 100000 -- Giảm sương mù tối đa
                Lighting.FogColor = Color3.fromRGB(255, 255, 255) -- Sương trắng
            end
        end)
    end
end

-- Khôi phục ánh sáng mặc định và ngắt đóng băng
local function disableNightVision()
    nightVisionEnabled = false
    nightVisionButton.Text = "Nhìn Trong Đêm: OFF"
    
    -- Ngắt vòng lặp đóng băng
    if nightVisionLoop then
        nightVisionLoop:Disconnect()
        nightVisionLoop = nil
    end
    
    -- Khôi phục trạng thái ban đầu
    Lighting.Ambient = defaultLighting.Ambient
    Lighting.Brightness = defaultLighting.Brightness
    Lighting.GlobalShadows = defaultLighting.GlobalShadows
    Lighting.ClockTime = defaultLighting.ClockTime
    Lighting.TimeOfDay = defaultLighting.TimeOfDay
    Lighting.FogEnd = defaultLighting.FogEnd
    Lighting.FogColor = defaultLighting.FogColor
end

-- Gọi hàm lưu trữ ngay khi script chạy
saveDefaultLighting()

-- Bật/tắt thủ công bằng nút
nightVisionButton.MouseButton1Click:Connect(function()
    if nightVisionEnabled then
        disableNightVision()
    else
        applyNightVision()
    end
end)

-- Nút mở/đóng menu
local openButton = Instance.new("TextButton")
openButton.Size = UDim2.new(0, 50, 0, 50)
openButton.Position = UDim2.new(0.5, -25, 0.5, -25)
openButton.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
openButton.TextColor3 = Color3.fromRGB(255, 255, 255)
openButton.Text = "Open"
openButton.Parent = screenGui

local openCorner = Instance.new("UICorner")
openCorner.CornerRadius = UDim.new(0, 8)
openCorner.Parent = openButton

-- Áp dụng draggable cho nút Open/Close
makeDraggable(openButton)

openButton.MouseButton1Click:Connect(function()
    mainFrame.Visible = not mainFrame.Visible
    openButton.Text = mainFrame.Visible and "Close" or "Open"
end)
